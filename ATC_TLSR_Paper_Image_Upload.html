<html>

<head>
	<title>ATC_TLSR_Paper BLE control</title>
</head>

<body>
	<script>
		let bleDevice;
		let gattServer;
		let Theservice;
		let writeCharacteristic;
		let writeCharacteristicImg;
		let reconnectTrys = 0;

		let imgArray = "";
		let imgArrayLen = 0;
		let uploadPart = 0;

		function resetVariables() {
			gattServer = null;
			Theservice = null;
			writeCharacteristic = null;
			writeCharacteristicImg = null;
			document.getElementById("log").value = '';
			imgArray = "";
			imgArrayLen = 0;
			uploadPart = 0;
		}

		function handleError(error) {
			console.log(error);
			resetVariables();
			if (bleDevice == null)
				return;
			if (reconnectTrys <= 5) {
				reconnectTrys++;
				connect();
			}
			else {
				addLog("Was not able to connect, aborting");
				reconnectTrys = 0;
			}
		}

		async function sendCommandImg(cmd) {
			if (writeCharacteristicImg) {
				await writeCharacteristicImg.writeValue(cmd);
			}
		}

		async function sendCommand(cmd) {
			if (writeCharacteristic) {
				await writeCharacteristic.writeValue(cmd);
			}
		}

		async function sendcmd(cmdTXT) {
			let cmd = hexToBytes(cmdTXT);
			addLog('Send CMD: ' + cmdTXT);
			await sendCommand(cmd);
		}

		function sendimg(cmdIMG) {
			startTime = new Date().getTime();
			imgArray = cmdIMG.replace(/(?:\r\n|\r|\n|,|0x| )/g, '');
			imgArrayLen = imgArray.length;
			uploadPart = 0;
			console.log('Sending image ' + imgArrayLen);
			sendCommand(hexToBytes("0000")).then(() => {
				sendCommand(hexToBytes("020000")).then(() => {
					sendIMGpart();
				})
			})
				.catch(handleError);
		}

		function sendIMGpart() {
			if (imgArray.length > 0) {
				let currentpart = "03" + imgArray.substring(0, 480);
				imgArray = imgArray.substring(480);
				setStatus('Current part: ' + uploadPart++ + " Time: " + (new Date().getTime() - startTime) / 1000.0 + "s");
				console.log('Curr Part: ' + currentpart);
				sendCommand(hexToBytes(currentpart)).then(() => {
					sendIMGpart();
				})
			} else {
				console.log('Last Part: ' + imgArray);
				sendCommand(hexToBytes("01")).then(() => {
					console.log("Update was send Time: " + (new Date().getTime() - startTime) / 1000.0 + "s");
					setStatus("Update was send in: " + (new Date().getTime() - startTime) / 1000.0 + "s");
				})
			}
		}

		function disconnect() {
			resetVariables();
			addLog('Disconnected.');
			document.getElementById("connectbutton").innerHTML = 'Connect';
		}

		function preConnect() {
			if (gattServer != null && gattServer.connected) {
				if (bleDevice != null && bleDevice.gatt.connected)
					bleDevice.gatt.disconnect();
			}
			else {
				connectTrys = 0;
				navigator.bluetooth.requestDevice({ optionalServices: ['13187b10-eba9-a3ba-044e-83d3217d9a38'], acceptAllDevices: true }).then(device => {
					device.addEventListener('gattserverdisconnected', disconnect);
					bleDevice = device;
					connect();
				}).catch(handleError);
			}
		}

		function reConnect() {
			connectTrys = 0;
			if (bleDevice != null && bleDevice.gatt.connected)
				bleDevice.gatt.disconnect();
			resetVariables();
			addLog("Reconnect");
			setTimeout(function () { connect(); }, 300);
		}

		function connect() {
			if (writeCharacteristic == null) {
				addLog("Connecting to: " + bleDevice.name);
				bleDevice.gatt.connect().then(server => {
					console.log('> Found GATT server');
					gattServer = server;
					return gattServer.getPrimaryService('13187b10-eba9-a3ba-044e-83d3217d9a38');
				}).then(service => {
					console.log('> Found service');
					Theservice = service;
					return Theservice.getCharacteristic('4b646063-6264-f3a7-8941-e65356ea82fe');
				}).then(characteristic => {
					addLog('> Found write characteristic');
					document.getElementById("connectbutton").innerHTML = 'Disconnected';
					writeCharacteristic = characteristic;
					return;
				}).catch(handleError);
			}
		}

		function setStatus(statusText) {
			document.getElementById("status").innerHTML = statusText;
		}

		function addLog(logTXT) {
			var today = new Date();
			var time = ("0" + today.getHours()).slice(-2) + ":" + ("0" + today.getMinutes()).slice(-2) + ":" + ("0" + today.getSeconds()).slice(-2) + " : ";
			document.getElementById("log").innerHTML += time + logTXT + '<br>';
			console.log(time + logTXT);
			while ((document.getElementById("log").innerHTML.match(/<br>/g) || []).length > 10) {
				var logs_br_position = document.getElementById("log").innerHTML.search("<br>");
				document.getElementById("log").innerHTML = document.getElementById("log").innerHTML.substring(logs_br_position + 4);
			}
		}

		function hexToBytes(hex) {
			for (var bytes = [], c = 0; c < hex.length; c += 2)
				bytes.push(parseInt(hex.substr(c, 2), 16));
			return new Uint8Array(bytes);
		}

		function bytesToHex(data) {
			return new Uint8Array(data).reduce(
				function (memo, i) {
					return memo + ("0" + i.toString(16)).slice(-2);
				}, "");
		}

		function intToHex(intIn) {
			var stringOut = "";
			stringOut = ("0000" + intIn.toString(16)).substr(-4)
			return stringOut.substring(2, 4) + stringOut.substring(0, 2);
		}

	</script>
	Welcome to ATCnetz.de ATC_TLSR_Paper BLE control,<br>Click connect and select the TLSR E-Paper Tracker you want to
	talk to.<br><br>
	The ATC_TLSR_Paper Firmware can be found here: <a href="https://github.com/atc1441/ATC_TLSR_Paper"
		target="_blank">https://github.com/atc1441/ATC_TLSR_Paper</a><br><br>

	<button id="connectbutton" type="button" onclick="preConnect();">Connect</button>
	<button id="connectbutton" type="button" onclick="reConnect();">Reconnect</button>
	<button id="connectbutton" type="button" onclick="document.getElementById('log').innerHTML = '';">Clear Log</button>
	<br><br>

	<input type="text" id="cmdTXT" value="0055">
	<button type="button" onclick="sendcmd(document.getElementById(&quot;cmdTXT&quot;).value);">Send Debug CMD</button>
	<br><br>

	<button type="button" onclick="sendimg(document.getElementById(&quot;cmdIMAGE&quot;).value);">Send Image to
		E-Paper</button>
	<br>

	<div id="status">
		Upload status</div>
	<br>

	<textarea id="cmdIMAGE" rows="10" cols="90">ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0fffffffffffffffc007fffffffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffe000000000007fffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffe00000000f007fffffffc0ffffffffffe00000000f007fffffffc0ffffffffffe00000000f007fffffffc0ffffffffffe00000000f007fffffffc0ffffffffffe00000000f007fffffffc0ffffffffffe00000000f007fffffffc0ffffffffffe00000000f007fffffffc0ffffffffffe00000000f007fffffffc0ffffffffffe00000000f007fffffffc0ffffffffffe00000000f007fffffffc0ffffffffffe00000000f007fffffffc0ffffffffffe00000000f007fffffffc0ffffffffffe00000000f007fffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffefffffffffffc0ffffffffffffffffff8fffffffffffc0ffffffffe1fffffffe0fffffffffffc0fffffffc03fffffff00fffffffffffc0fffffffc03ffffffc00fffffffffffc0fffffff803ffffff000fffffffffffc0fffffff803fffff8000fffffffffffc0fffffff803ffffe0000fffffffffffc0fffffff803ffff00000fffffffffffc0fffffff803fffc00000fffffffffffc0fffffff803fff000000fffffffffffc0fffffff801ff8000000fffffffffffc0fffffff800fe0000000fffffffffffc0fffffff800780000000fffffffffffc0fffffff800000000007fffffffffffc0fffffff80000000003ffffffffffffc0fffffffc000000001fffffffffffffc0fffffffc00000001ffffffffffffffc0fffffffc0000000fffffffffffffffc0fffffffe0000007fffffffffffffffc0fffffffe000001ffffffffffffffffc0ffffffff0000007fffffffffffffffc0ffffffff80000007ffffffffffffffc0ffffffffe0000000ffffffffffffffc0fffffffff80000000fffffffffffffc0fffffffffe00000001ffffffffffffc0ffffffffffc00000001fffffffffffc0fffffffffff00000000fffffffffffc0fffffffffffe0000000fffffffffffc0ffffffffffffc000000fffffffffffc0fffffffffffff800000fffffffffffc0fffffffffffffe00000fffffffffffc0ffffffffffffffc0000fffffffffffc0fffffffffffffff8000fffffffffffc0fffffffffffffffe000fffffffffffc0ffffffffffffffffc00fffffffffffc0fffffffffffffffff80fffffffffffc0fffffffffffffffffe0fffffffffffc0ffffffffffffffffffcfffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffc7ffffffffffffffc0fffffffffffff8003fffffffffffffc0ffffffffffffe0000fffffffffffffc0ffffffffffff800003ffffffffffffc0ffffffffffff000001ffffffffffffc0fffffffffffe000000ffffffffffffc0fffffffffffc0000007fffffffffffc0fffffffffff80000003fffffffffffc0fffffffffff80000003fffffffffffc0fffffffffff00000001fffffffffffc0fffffffffff00000001fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe000fe000fffffffffffc0ffffffffffc003ff800fffffffffffc0ffffffffffc00fffe007ffffffffffc0ffffffffffc00fffe007ffffffffffc0ffffffffffc01ffff007ffffffffffc0ffffffffffc01ffff007ffffffffffc0ffffffffffc01ffff007ffffffffffc0ffffffffffc01ffff007ffffffffffc0ffffffffffc01ffff007ffffffffffc0ffffffffffc00fffe007ffffffffffc0ffffffffffc00fffe007ffffffffffc0ffffffffffc007ffc007ffffffffffc0ffffffffffe001ff000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0fffffffffff00000001fffffffffffc0fffffffffff00000001fffffffffffc0fffffffffff80000003fffffffffffc0fffffffffff80000003fffffffffffc0fffffffffffc0000007fffffffffffc0fffffffffffe000000ffffffffffffc0ffffffffffff000001ffffffffffffc0ffffffffffff800003ffffffffffffc0ffffffffffffe0000fffffffffffffc0fffffffffffff8003fffffffffffffc0ffffffffffffff83ffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffc000000fffffffffffc0fffffffffffe0000000fffffffffffc0fffffffffffc0000000fffffffffffc0fffffffffff80000000fffffffffffc0fffffffffff00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffc00000000fffffffffffc0ffffffffffc00000000fffffffffffc0ffffffffffc00000000fffffffffffc0ffffffffffc00000000fffffffffffc0ffffffffffc0007fffffffffffffffc0ffffffffffc003ffffffffffffffffc0ffffffffffc007ffffffffffffffffc0ffffffffffe00fffffffffffffffffc0ffffffffffe00fffffffffffffffffc0ffffffffffe00fffffffffffffffffc0fffffffffff00fffffffffffffffffc0fffffffffff807ffffffffffffffffc0fffffffffff807ffffffffffffffffc0fffffffffffc01ffffffffffffffffc0ffffffffffff0000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffe00000000fffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0ffffffffffffffffffffffffffffffc0</textarea><br>

	<div id="log">
		<br>
	</div>
</body>

</html>